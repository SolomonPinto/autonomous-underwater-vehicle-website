<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Three.js 3D Model with Water</title>
    <style>
      * { margin: 0; padding: 0; }
      body { width: 100vw; height: 100vh; overflow: hidden; }
      canvas { display: block; }
    </style>
  </head>
  <body>
    <!-- Import map tells browser where 'three' and 'three/addons' live -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.1/examples/jsm/"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      import { Water } from 'three/addons/objects/Water.js';

      // Scene
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      // Camera
      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(2, 2, 4);

      // Renderer
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputEncoding = THREE.sRGBEncoding;
      document.body.appendChild(renderer.domElement);

      // Water plane
      const waterGeometry = new THREE.PlaneGeometry(1000, 1000);
      const water = new Water(waterGeometry, {
        color: '#0000FF',
        scale: 4,
        flowDirection: new THREE.Vector2(1, 1),
        textureWidth: 1024,
        textureHeight: 1024
      });
      water.rotation.x = Math.PI / 2;
      water.position.y = 0;
      scene.add(water);

      // Controls
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);

      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      // Load GLB model
      const loader = new GLTFLoader();

loader.load(
  'finished_assembly.glb',
  (gltf) => {
    const model = gltf.scene;

    model.traverse((child) => {
      if (child.isMesh) {
        child.castShadow = true;
        child.receiveShadow = true;
      }
    });

    // 1) Center model at origin
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());

    // Move model so its center is exactly at (0, 0, 0)
    model.position.x -= center.x;
    model.position.y -= center.y;
    model.position.z -= center.z;

    scene.add(model);

    // 2) Compute size and set camera distance
    const maxDim = Math.max(size.x, size.y, size.z);
    const fitOffset = 2.0; // increase this if still too close
    const distance = maxDim * fitOffset;

    // Isometric-like position: 45° around Y, 35° above
    const angle = Math.PI / 4;
    const elev  = THREE.MathUtils.degToRad(45);

    camera.position.set(
      distance * Math.cos(angle),
      distance * Math.sin(elev),
      distance * Math.sin(angle)
    );

    camera.near = maxDim / 100;
    camera.far  = maxDim * 100;
    camera.updateProjectionMatrix();

    // 3) Look exactly at model center (origin now)
    controls.target.set(0, 0, 0);
    controls.update();
  },
  undefined,
  (error) => console.error('Error loading GLB:', error)
);


      // Resize
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Animation loop (including water time)
      function animate() {
        requestAnimationFrame(animate);

        const t = performance.now() * 0.001;
        if (water.material && water.material.uniforms && water.material.uniforms['time']) {
          water.material.uniforms['time'].value = t;
        }

        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    </script>
  </body>
</html>
